---
import type { MenuItem } from '../lib/wp-menu';
import { getFseMenu } from '../lib/wp-menu';

import { Moon, SunMedium, Download, ChevronDown } from '@lucide/astro';
import Button from '@components/ui/Button.astro';
import Logo from '@components/ui/Logo.astro';

const menuItems: MenuItem[] = await getFseMenu('navigation');
---

<!-- Spacer so fixed header doesn't overlap content -->
<div class="pointer-events-none relative h-16 w-full opacity-0 sm:h-20"></div>

<header
    id="header"
    class="fixed top-2 z-50 w-full px-3 sm:top-4 sm:px-4 lg:px-6"
>
    <div
        id="site-container"
        class="container mx-auto flex h-14 items-center justify-between border-[0.5px] border-transparent px-4 py-2.5 transition-all duration-300 sm:h-15 sm:px-6"
    >
        <!-- Logo -->
        <div class="z-50 flex-shrink-0">
            <Logo />
        </div>

        <!-- Mobile Menu Background Overlay -->
        <div
            id="mobileMenuBackground"
            class="fixed inset-0 z-20 hidden h-screen w-screen bg-white/90 backdrop-blur-sm duration-300 ease-out dark:bg-neutral-950/90"
        >
        </div>

        <!-- Navigation -->
        <nav
            class="relative z-30 flex w-full flex-row-reverse justify-start text-sm text-neutral-500 sm:flex-row sm:items-center sm:justify-end dark:text-neutral-400"
        >
            <!-- Mobile Menu Toggle Buttons -->
            <div class="flex items-center gap-2 sm:hidden">
                <!-- Dark Mode Toggle (Mobile) -->
                <div
                    id="darkToggleMobile"
                    class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-full border-[0.5px] border-[#f3f3ff] bg-gradient-to-b from-white to-[#edeefa] transition-transform duration-200 active:scale-95 dark:border-neutral-600 dark:from-neutral-800 dark:to-neutral-600"
                >
                    <div
                        class="relative flex h-6 w-6 items-center justify-center overflow-hidden rounded-full border-[0.5px] border-[#7fa1ff] bg-[#7fa1ff] bg-gradient-to-b from-[#85a6ff] to-[#2d6dc3]"
                        style="box-shadow: 0px 2px 3px 0 rgba(55,52,209,0.21);"
                    >
                        <SunMedium
                            class="ease mobile-sun absolute hidden h-4 w-4 transform text-white transition duration-200"
                        />
                        <Moon
                            class="ease mobile-moon absolute hidden h-4 w-4 transform text-white transition duration-200"
                        />
                    </div>
                </div>

                <!-- Hamburger Menu Button -->
                <div
                    id="openMenu"
                    class="flex h-10 w-10 cursor-pointer items-center justify-center transition-transform duration-200 active:scale-90"
                >
                    <svg
                        class="h-7 w-7 text-neutral-700 dark:text-neutral-200"
                        fill="none"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path d="M4 8h16M4 16h16"></path>
                    </svg>
                </div>

                <!-- Close Menu Button -->
                <div
                    id="closeMenu"
                    class="hidden h-10 w-10 cursor-pointer items-center justify-center transition-transform duration-200 active:scale-90"
                >
                    <svg
                        class="h-6 w-6 text-neutral-600 dark:text-neutral-200"
                        fill="none"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
            </div>

            <!-- Menu Items -->
            <div
                id="menu"
                class="fixed top-[68px] right-3 left-3 z-40 hidden h-auto w-auto flex-col items-center justify-start pt-6 pb-5 text-sm duration-300 ease-out sm:relative sm:top-0 sm:right-0 sm:left-0 sm:flex sm:flex-row sm:py-0"
            >
                <!-- Mobile Menu Background -->
                <div
                    class="absolute inset-0 top-0 right-0 block h-full w-full sm:hidden"
                >
                    <div
                        class="relative h-full w-full rounded-2xl border border-dashed border-neutral-300 bg-white/95 shadow-lg backdrop-blur-md dark:border-neutral-700 dark:bg-neutral-950/95"
                    >
                    </div>
                </div>

                <!-- Menu Links -->
                <div
                    class="relative z-10 flex w-full flex-col items-center gap-1 sm:w-auto sm:flex-row sm:gap-0"
                >
                    {
                        menuItems.map((item) => {
                            const hasChildren = item.children?.length > 0;

                            return (
                                <div class="group relative w-full sm:w-auto">
                                    {/* top-level link */}
                                    <a
                                        href={item.url}
                                        class="hover:text-primary relative flex w-full items-center justify-center rounded-lg px-5 py-2.5 text-center font-medium tracking-wide text-neutral-700 transition-all duration-200 ease-out active:scale-[0.98] sm:w-auto sm:rounded-none sm:px-3 sm:py-2 sm:hover:bg-transparent sm:active:scale-100 md:px-4 dark:text-neutral-200 dark:hover:bg-neutral-800/50 dark:hover:text-white sm:dark:hover:bg-transparent"
                                    >
                                        <span>{item.label}</span>
                                        {hasChildren && (
                                            <ChevronDown class="ml-2 hidden h-4 w-4 opacity-70 transition-transform duration-200 group-hover:rotate-180 sm:inline-block" />
                                        )}
                                    </a>

                                    {/* desktop dropdown */}
                                    {hasChildren && (
                                        <div class="pointer-events-none absolute top-full left-0 hidden pt-2 opacity-0 transition group-hover:pointer-events-auto group-hover:opacity-100 sm:block">
                                            <div class="min-w-56 overflow-hidden rounded-xl border border-neutral-200 bg-white shadow-lg dark:border-neutral-800 dark:bg-neutral-950">
                                                {item.children.map((child) => (
                                                    <a
                                                        href={child.url}
                                                        class="block px-4 py-2.5 text-sm text-neutral-700 hover:bg-neutral-50 dark:text-neutral-200 dark:hover:bg-neutral-800/50"
                                                    >
                                                        {child.label}
                                                    </a>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* mobile “children” (simple indented list) */}
                                    {hasChildren && (
                                        <div class="-mt-1 w-full px-5 pb-2 sm:hidden">
                                            <div class="space-y-1 border-l border-neutral-200 pl-3 dark:border-neutral-800">
                                                {item.children.map((child) => (
                                                    <a
                                                        href={child.url}
                                                        class="hover:text-primary block py-2 text-sm text-neutral-600 dark:text-neutral-300"
                                                    >
                                                        {child.label}
                                                    </a>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })
                    }
                </div>

                <!-- Contact Button (Mobile) -->
                <div class="relative z-10 mt-3 w-full px-5 sm:hidden">
                    <Button
                        url="javascript:void(0);"
                        type="fill"
                        className="m-auto w-full justify-center"
                    >
                        Resume <Download size={16} />
                    </Button>
                </div>
            </div>

            <!-- Desktop Actions -->
            <div
                class="relative ml-4 hidden items-center gap-2 sm:flex lg:ml-6"
            >
                <span
                    class="separator-line mt-5 hidden h-5 w-px -translate-y-1/2 bg-[rgba(183,202,255,0.5)] sm:inline-block"
                ></span>

                <!-- Dark Mode Toggle (Desktop) -->
                <div
                    id="darkToggle"
                    class="relative mx-1 flex h-9 cursor-pointer items-center gap-1.5 rounded-full border-[0.5px] border-[#f3f5ff] bg-linear-to-b from-white to-[#edf1fa] px-2 font-medium transition-all duration-200 hover:scale-105 hover:shadow-md active:scale-95 dark:border-neutral-600 dark:from-neutral-800 dark:to-neutral-600"
                >
                    <div
                        class="relative flex h-6 w-6 shrink-0 items-center justify-center overflow-hidden rounded-full border-[0.5px] border-[#7fa1ff] bg-linear-to-b from-[#85a6ff] to-[#2d6dc3]"
                        style="box-shadow: 0px 2px 3px 0 rgba(55,52,209,0.21);"
                    >
                        <SunMedium
                            id="sun"
                            class="ease absolute hidden h-4 w-4 transform text-white transition duration-200"
                        />
                        <Moon
                            id="moon"
                            class="ease absolute hidden h-4 w-4 transform text-white transition duration-200"
                        />
                    </div>

                    <span class="hidden whitespace-nowrap sm:inline-block">
                        <span
                            id="dayText"
                            class="flex-shrink-0 text-left text-sm text-[#6f6c8f] dark:text-neutral-400"
                            >Light</span
                        >
                        <span
                            id="nightText"
                            class="hidden flex-shrink-0 text-left text-sm text-[#6f6c8f] dark:text-neutral-400"
                            >Dark</span
                        >
                    </span>
                </div>
            </div>
        </nav>
    </div>
</header>

<style>
    #header {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @media (max-width: 639px) {
        #menu {
            max-width: calc(100vw - 24px);
            transform: translateY(-10px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #menu:not(.hidden) {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        #mobileMenuBackground {
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }
        #mobileMenuBackground:not(.hidden) {
            opacity: 1;
        }
        body {
            overflow-x: hidden;
        }
        nav a:active {
            background-color: var(--color-neutral-100);
        }
        .dark nav a:active {
            background-color: rgba(255, 255, 255, 0.05);
        }
    }

    nav a {
        position: relative;
    }

    @media (min-width: 640px) {
        nav a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 70%;
            height: 2px;
            background: var(--color-primary);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 2px;
        }
        nav a:hover::after {
            transform: translateX(-50%) scaleX(1);
        }
    }

    #darkToggle,
    #darkToggleMobile {
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    @supports (backdrop-filter: blur(12px)) {
        #mobileMenuBackground {
            backdrop-filter: blur(12px);
        }
        @media (max-width: 639px) {
            #menu > div > div {
                backdrop-filter: blur(16px);
            }
        }
    }

    .flex-shrink-0 {
        min-width: fit-content;
    }

    @media (min-width: 640px) and (max-width: 767px) {
        nav a {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            font-size: 0.8125rem;
        }
    }

    @media (max-width: 639px) {
        button,
        a,
        [role='button'] {
            -webkit-tap-highlight-color: transparent;
        }
        #menu > div > div {
            box-shadow:
                0 10px 25px -5px rgba(0, 0, 0, 0.1),
                0 8px 10px -6px rgba(0, 0, 0, 0.05);
        }
        .dark #menu > div > div {
            box-shadow:
                0 10px 25px -5px rgba(0, 0, 0, 0.3),
                0 8px 10px -6px rgba(0, 0, 0, 0.2);
        }
    }
</style>

<script>
    declare global {
        interface Window {
            closeMobileMenu: () => void;
        }
    }

    // ---------- Dark mode (persisted) ----------
    function getPreferredTheme(): 'dark' | 'light' {
        const saved = localStorage.getItem('theme');
        if (saved === 'dark' || saved === 'light') return saved;
        return window.matchMedia?.('(prefers-color-scheme: dark)').matches
            ? 'dark'
            : 'light';
    }

    function applyTheme(theme: 'dark' | 'light') {
        document.documentElement.classList.toggle('dark', theme === 'dark');
        localStorage.setItem('theme', theme);
    }

    function toggleTheme() {
        const isDark = document.documentElement.classList.contains('dark');
        applyTheme(isDark ? 'light' : 'dark');
    }

    // ---------- Sync icons/text ----------
    function syncDarkModeIcons() {
        const isDark = document.documentElement.classList.contains('dark');
        const sunIcons = document.querySelectorAll('#sun, .mobile-sun');
        const moonIcons = document.querySelectorAll('#moon, .mobile-moon');

        if (isDark) {
            moonIcons.forEach((icon) => icon.classList.remove('hidden'));
            sunIcons.forEach((icon) => icon.classList.add('hidden'));
            document.getElementById('dayText')?.classList.add('hidden');
            document.getElementById('nightText')?.classList.remove('hidden');
        } else {
            sunIcons.forEach((icon) => icon.classList.remove('hidden'));
            moonIcons.forEach((icon) => icon.classList.add('hidden'));
            document.getElementById('dayText')?.classList.remove('hidden');
            document.getElementById('nightText')?.classList.add('hidden');
        }
    }

    // ---------- Mobile menu ----------
    const openMenu = document.getElementById('openMenu');
    const closeMenu = document.getElementById('closeMenu');
    const menu = document.getElementById('menu');
    const mobileMenuBackground = document.getElementById(
        'mobileMenuBackground'
    );

    function openMobileMenu() {
        menu?.classList.remove('hidden');
        mobileMenuBackground?.classList.remove('hidden');
        openMenu?.classList.add('hidden');
        closeMenu?.classList.remove('hidden');
        closeMenu?.classList.add('flex');
        document.body.style.overflow = 'hidden';
    }

    function closeMobileMenu() {
        menu?.classList.add('hidden');
        mobileMenuBackground?.classList.add('hidden');
        closeMenu?.classList.add('hidden');
        closeMenu?.classList.remove('flex');
        openMenu?.classList.remove('hidden');
        document.body.style.overflow = '';
    }

    window.closeMobileMenu = closeMobileMenu;

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', () => {
        // theme init
        applyTheme(getPreferredTheme());
        syncDarkModeIcons();

        // theme toggles
        document.getElementById('darkToggle')?.addEventListener('click', () => {
            toggleTheme();
            syncDarkModeIcons();
        });

        document
            .getElementById('darkToggleMobile')
            ?.addEventListener('click', () => {
                toggleTheme();
                syncDarkModeIcons();
            });

        // menu toggles
        openMenu?.addEventListener('click', openMobileMenu);
        closeMenu?.addEventListener('click', closeMobileMenu);
        mobileMenuBackground?.addEventListener('click', closeMobileMenu);

        // click-to-close on mobile
        menu?.querySelectorAll('a')?.forEach((link) => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 640) closeMobileMenu();
            });
        });
    });

    // keep icons synced if something else toggles .dark
    const observer = new MutationObserver(syncDarkModeIcons);
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class'],
    });

    // resize guard
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 640) {
            document.body.style.overflow = '';
            // in desktop layout your menu is "sm:flex" anyway; but if someone forced hidden, unhide:
            menu?.classList.remove('hidden');
            mobileMenuBackground?.classList.add('hidden');
            closeMenu?.classList.add('hidden');
            closeMenu?.classList.remove('flex');
            openMenu?.classList.remove('hidden');
        }
    });
</script>
